{% extends 'base.html' %}
{% block title %}{% if consumo %}Editar{% else %}Nuevo{% endif %} Consumo de Refrigerios{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header card-header-lila">
    <h3 class="mb-0 text-lila fw-bold">
      {% if consumo %}Editar Registro de Consumo{% else %}Registrar Consumo Diario de Refrigerios{% endif %}
    </h3>
  </div>
  <div class="card-body p-4">
    <form action="{{ url_for('consumo_nuevo') if not consumo else url_for('consumo_editar', consumo_id=consumo.id) }}" method="POST">
      <h5 class="text-lila">Datos Generales</h5>
      <div class.="row g-3 mb-4">
        <div class="col-md-4"><label class="form-label">Fecha</label><input type="date" name="fecha" class="form-control" value="{{ consumo.fecha.strftime('%Y-%m-%d') if consumo else '' }}" required></div>
        <div class="col-md-4"><label class="form-label">Casino</label><select name="casino" class="form-select" required><option value="Casino 1" {% if casino == 'Casino 1' %}selected{% endif %}>Casino 1</option><option value="Casino 2" {% if casino == 'Casino 2' %}selected{% endif %}>Casino 2</option></select></div>
        <div class="col-md-4"><label class="form-label">Responsable</label><input type="text" name="responsable" class="form-control" value="{{ consumo.responsable if consumo else current_user.username if current_user.is_authenticated else '' }}" required></div>
        <div class="col-md-8"><label class="form-label">Descripci√≥n del Refrigerio</label><input type="text" name="descripcion" placeholder="Ej: Jugo de naranja y empanada de carne" class="form-control" value="{{ consumo.descripcion if consumo else '' }}" required></div>
        <div class="col-md-4"><label class="form-label"># de Refrigerios Servidos</label><input type="number" step="1" min="1" name="cantidad_total" class="form-control" value="{{ consumo.cantidad_total if consumo else '' }}" required></div>
      </div>
      <hr>
      <h5 class="text-lila mt-4">Composici√≥n (qu√© productos y cantidad POR CADA refrigerio)</h5>
      <div id="items-container">
        {% if consumo and consumo.items %}
          {% for item in consumo.items %}
          <div class="row g-2 mb-2 item-row">
            <div class="col-8"><label class="form-label">Producto del Inventario</label><select name="producto_id[]" class="form-select"><option value="">-- Seleccione --</option>{% for p in productos %}<option value="{{ p.id }}" {% if p.id == item.producto_id %}selected{% endif %}>{{ p.nombre }} ({{ p.unidad }})</option>{% endfor %}</select></div>
            <div class="col-3"><label class="form-label">Cant. por Unidad</label><input type="number" step="0.01" name="cantidad[]" class="form-control" value="{{ item.cantidad_consumida / consumo.cantidad_total }}"></div>
            <div class="col-1 d-flex align-items-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.item-row').remove()">√ó</button></div>
          </div>
          {% endfor %}
        {% else %}
          <div class="row g-2 mb-2 item-row">
            <div class="col-8"><label class="form-label">Producto del Inventario</label><select name="producto_id[]" class="form-select"><option value="">-- Seleccione --</option>{% for p in productos %}<option value="{{ p.id }}">{{ p.nombre }} ({{ p.unidad }})</option>{% endfor %}</select></div>
            <div class="col-3"><label class="form-label">Cant. por Unidad</label><input type="number" step="0.01" name="cantidad[]" class="form-control"></div>
            <div class="col-1 d-flex align-items-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.item-row').remove()">√ó</button></div>
          </div>
        {% endif %}
      </div>
      <button type="button" id="add-item" class="btn btn-sm btn-outline-primary mt-2">‚ûï Agregar otro producto</button>
      <div class="text-end mt-4"><a href="{{ url_for('consumo_list') }}" class="btn btn-secondary">‚¨ÖÔ∏è Cancelar</a><button type="submit" class="btn btn-lila">üíæ Guardar Registro</button></div>
    </form>
  </div>
</div>
<script>
document.getElementById('add-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const firstRow = container.querySelector('.item-row');
    const newRow = firstRow.cloneNode(true);
    newRow.querySelectorAll('select, input').forEach(el => el.value = '');
    container.appendChild(newRow);
});
</script>
{% endblock %}